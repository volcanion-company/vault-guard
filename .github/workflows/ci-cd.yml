name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  SOLUTION_PATH: 'vault-guard.sln'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better SonarQube analysis
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
    
    - name: Run unit tests with coverage
      id: test
      run: |
        dotnet test ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
      continue-on-error: true
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: TestResults/**/*.trx
    
    - name: Upload coverage reports (OpenCover)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports-opencover
        path: TestResults/**/coverage.opencover.xml
    
    - name: Upload coverage reports (Cobertura)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports-cobertura
        path: TestResults/**/coverage.cobertura.xml
        if-no-files-found: warn

  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: staging  # Sử dụng environment staging để truy cập secrets
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Disable shallow clone for better analysis
    
    - name: Validate SonarQube secrets
      run: |
        if [ -z "${{ secrets.SONAR_TOKEN }}" ] || [ -z "${{ secrets.SONAR_HOST_URL }}" ] || [ -z "${{ secrets.SONAR_PROJECT_KEY }}" ]; then
          echo "::error::SonarQube secrets are not configured properly"
          echo "::error::Please configure the following secrets in your repository:"
          echo "::error::- SONAR_TOKEN: Your SonarQube authentication token"
          echo "::error::- SONAR_HOST_URL: Your SonarQube server URL (e.g., https://sonarcloud.io)"
          echo "::error::- SONAR_PROJECT_KEY: Your SonarQube project key"
          exit 1
        fi
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Cache SonarQube packages
      uses: actions/cache@v3
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
    
    - name: Install SonarQube scanner
      run: dotnet tool install --global dotnet-sonarscanner
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: Begin SonarQube analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      run: |
        dotnet sonarscanner begin \
          /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
          /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" \
          /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
          /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml" \
          /d:sonar.cs.vstest.reportsPaths="**/TestResults/**/*.trx" \
          /d:sonar.coverage.exclusions="**Tests*.cs,**/*Tests/**/*"
    
    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
    
    - name: Run unit tests with coverage
      run: |
        dotnet test ${{ env.SOLUTION_PATH }} \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
      continue-on-error: true
    
    - name: End SonarQube analysis
      if: always()
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
    
    - name: Check if SonarQube report exists
      id: check_report
      run: |
        if [ -f ".scannerwork/report-task.txt" ]; then
          echo "report_exists=true" >> $GITHUB_OUTPUT
          echo "SonarQube report found"
        else
          echo "report_exists=false" >> $GITHUB_OUTPUT
          echo "::warning::SonarQube report not found, skipping Quality Gate check"
        fi
    
    - name: SonarQube Quality Gate check
      if: steps.check_report.outputs.report_exists == 'true'
      uses: sonarsource/sonarqube-quality-gate-action@master
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      continue-on-error: true

  code-coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download coverage reports (Cobertura)
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports-cobertura
        path: TestResults
      continue-on-error: true
    
    - name: Download coverage reports (OpenCover)
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports-opencover
        path: TestResults
      continue-on-error: true
    
    - name: Install ReportGenerator
      run: dotnet tool install --global dotnet-reportgenerator-globaltool
    
    - name: List downloaded files
      run: |
        echo "Checking TestResults directory:"
        ls -la TestResults/ || echo "TestResults directory not found"
        find TestResults -name "*.xml" -type f || echo "No XML files found"
    
    - name: Generate coverage report
      run: |
        if find TestResults -name "coverage.*.xml" -type f | grep -q .; then
          reportgenerator \
            -reports:"TestResults/**/coverage.*.xml" \
            -targetdir:"TestResults/Report" \
            -reporttypes:"Html;MarkdownSummaryGithub" \
            -historydir:"TestResults/History"
        else
          echo "::warning::No coverage files found, skipping report generation"
          mkdir -p TestResults/Report
          echo "# Coverage Report" > TestResults/Report/SummaryGithub.md
          echo "No coverage data available for this build." >> TestResults/Report/SummaryGithub.md
        fi
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-html
        path: TestResults/Report
    
    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: TestResults/Report/SummaryGithub.md
